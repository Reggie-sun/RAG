# Reverse proxy / TLS termination for RAG stack
{
    email {$CADDY_ACME_EMAIL}
    admin off
}

http://{$RAG_DOMAIN:localhost} {
    @health {
        path /healthz /ping
    }
    respond @health 200
    redir https://{$RAG_DOMAIN:localhost}{uri} permanent
}

{$RAG_DOMAIN:localhost} {
    encode zstd gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Permissions-Policy "camera=(), microphone=(), geolocation=(self)"
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
        Access-Control-Allow-Headers "*"
    }

    @preflight {
        method OPTIONS
        header Origin "*"
        header Access-Control-Request-Method "*"
    }
    handle @preflight {
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
            Access-Control-Allow-Headers "*"
            Access-Control-Max-Age 86400
        }
        respond 204
    }

    reverse_proxy {$RAG_UPSTREAM:rag-api:8000} {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            versions h2c 1.1
        }
    }
}
