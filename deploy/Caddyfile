# Reverse proxy / TLS termination for RAG stack
{
    # 内网/隧道场景，先用内部证书，避免 ACME 失败导致 502
    # 如需公网可信证书，请改用 DNS-01 或直接暴露 80/443 再跑 ACME
    email {$CADDY_ACME_EMAIL:admin@example.com}
    admin off
    auto_https disable_redirects
}

(common_site_base) {
    @acme path /.well-known/acme-challenge/*
    @token path_regexp token ^/.well-known/acme-challenge/(.+)$

    handle @acme {
        rewrite @token /acme-v02.api.letsencrypt.org-directory/challenge_tokens/{http.regexp.token.1}
        try_files {path} /acme.zerossl.com-v2-dv90/challenge_tokens/{http.regexp.token.1}
        root * /data/caddy/acme
        file_server
    }

    encode zstd gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Permissions-Policy "camera=(), microphone=(), geolocation=(self)"
    }
}

(gpu_site) {
    import common_site_base
    reverse_proxy {$RAG_GPU_UPSTREAM:rag-api:8000}
}

(cpu_site) {
    import common_site_base
    reverse_proxy {$RAG_CPU_UPSTREAM:cpu-api:8001}
}

# Cloudflare DNS-01 TLS 配置片段
(tls_dns_cf) {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }
}

http://{$RAG_DOMAIN:localhost} {
    import gpu_site
}

https://{$RAG_DOMAIN:localhost} {
    import gpu_site
    import tls_dns_cf
}

http://api.srj666.com {
    import gpu_site
}

https://api.srj666.com {
    import gpu_site
    import tls_dns_cf
}

http://cpu.srj666.com {
    import cpu_site
}

https://cpu.srj666.com {
    import cpu_site
    import tls_dns_cf
}

http://srj666.com {
    import gpu_site
}

https://srj666.com {
    import gpu_site
    import tls_dns_cf
}
