# Reverse proxy / TLS termination for RAG stack
{
    email {$CADDY_ACME_EMAIL}
    admin off
    auto_https disable_redirects
}

(common_site) {
    @acme path /.well-known/acme-challenge/*
    @token path_regexp token ^/.well-known/acme-challenge/(.+)$

    handle @acme {
        rewrite @token /acme-v02.api.letsencrypt.org-directory/challenge_tokens/{http.regexp.token.1}
        try_files {path} /acme.zerossl.com-v2-dv90/challenge_tokens/{http.regexp.token.1}
        root * /data/caddy/acme
        file_server
    }

    encode zstd gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Permissions-Policy "camera=(), microphone=(), geolocation=(self)"
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
        Access-Control-Allow-Headers "*"
    }

    @preflight {
        method OPTIONS
        header Origin "*"
        header Access-Control-Request-Method "*"
    }
    handle @preflight {
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
            Access-Control-Allow-Headers "*"
            Access-Control-Max-Age 86400
        }
        respond 204
    }

    reverse_proxy {$RAG_UPSTREAM:rag-api:8000} {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

http://{$RAG_DOMAIN:localhost} {
    import common_site
}

https://{$RAG_DOMAIN:localhost} {
    import common_site
}

http://api.srj666.com {
    import common_site
}

https://api.srj666.com {
    import common_site
}

http://cpu.srj666.com {
    import common_site
}

https://cpu.srj666.com {
    import common_site
}

http://srj666.com {
    import common_site
}

https://srj666.com {
    import common_site
}
