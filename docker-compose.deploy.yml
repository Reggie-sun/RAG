version: "3.9"

services:
  rag-api:
    ports: []

  cpu-api:
    ports: []

  caddy:
    platform: linux/amd64
    image: iarekylew00t/caddy-cloudflare:latest
    restart: unless-stopped
    depends_on:
      - rag-api
      - cpu-api
    env_file:
      - .env.docker
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config

  cloudflared:
    build:
      context: ./deploy/cloudflared
    image: rag-cloudflared:latest
    restart: unless-stopped
    depends_on:
      - caddy
    env_file:
      - .env.docker
    command:
      - cloudflared
      - tunnel
      - --config
      - /etc/cloudflared/config.yml
      - --no-autoupdate
      - run
    volumes:
      - ./deploy/cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      - ./deploy/cloudflared/credentials:/etc/cloudflared/credentials:ro

volumes:
  caddy-data:
  caddy-config:
