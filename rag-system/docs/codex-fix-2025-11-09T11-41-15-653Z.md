# Bug Fix Report

## Problem Description
RAG系统前端404错误修复

问题描述：
前端在调用 `/api/index/status` 接口时出现404错误。

问题分析：
1. 后端有两个服务运行在8000和8001端口
2. 前端配置VITE_CPU_API_BASE_URL=http://localhost:8001
3. 前端使用cpuClient调用/api/index/status接口
4. 实际请求URL应该是http://localhost:8001/api/index/status
5. 但是/api/index/status路由在backend/cpu_tasks_app.py中可能没有正确定义

主要文件：
- /home/reggie/vscode_folder/RAG/rag-system/frontend/src/services/api.ts (第26-29行)
- /home/reggie/vscode_folder/RAG/rag-system/backend/cpu_tasks_app.py
- /home/reggie/vscode_folder/RAG/rag-system/backend/routers/status.py (第58-60行)

期望修复：
确保前端能够成功调用/api/index/status接口获取索引状态信息，不再出现404错误。

技术细节：
- 前端使用axios cpuClient，baseURL为VITE_CPU_API_BASE_URL (http://localhost:8001)
- 接口应该返回IndexStatus类型的数据：{documents: number, chunks: number, updated_at: string}
- 需要确保CPU任务应用正确包含了status路由器

## Fix Time
2025-11-09T11:41:15.653Z

## Modified Files
List all modified files with their full paths

- /home/reggie/vscode_folder/RAG/rag-system/backend/cpu_tasks_app.py
- /home/reggie/vscode_folder/RAG/rag-system/backend/main.py
- /home/reggie/vscode_folder/RAG/rag-system/backend/routers/status.py
- /home/reggie/vscode_folder/RAG/rag-system/docs/codex-fix-2025-11-09T11-41-15-653Z.md

## Detailed Changes
For each file, provide detailed explanation:

### File: backend/cpu_tasks_app.py
**Changes**: Mount the shared index-status router alongside upload/status routes so the CPU FastAPI service exposes `/api/index/status`.

**Before**:
```python
    app.include_router(upload_router)
    app.include_router(status_router)
```

**After**:
```python
    app.include_router(upload_router)
    app.include_router(index_status_router)
    app.include_router(status_router)
```

**Reason**: The ingestion service (port 8001) did not guarantee that the index-status endpoint was registered, which produced a 404 for the frontend; mounting the dedicated router makes the route available regardless of other status features.

### File: backend/main.py
**Changes**: Register the new shared index-status router on the primary GPU FastAPI app so `/api/index/status` continues to be available on port 8000.

**Before**:
```python
app.include_router(search_router)
app.include_router(status_router)
```

**After**:
```python
app.include_router(search_router)
app.include_router(index_status_router)
app.include_router(status_router)
```

**Reason**: After splitting the index-status route into its own router, the primary API also needs to mount it to keep parity with the previous surface area.

### File: backend/routers/status.py
**Changes**: Split the `/api/index/status` handler into `index_status_router` so that it can be mounted independently by services that only need index metadata, while keeping the rest of the status endpoints untouched.

**Before**:
```python
router = APIRouter(prefix="/api", tags=["status"])

@router.get("/index/status")
async def get_index_status() -> Dict[str, Any]:
    return _load_status()
```

**After**:
```python
router = APIRouter(prefix="/api", tags=["status"])
index_status_router = APIRouter(prefix="/api", tags=["status"])

@index_status_router.get("/index/status")
async def get_index_status() -> Dict[str, Any]:
    return _load_status()
```

**Reason**: Decoupling the lightweight index-status route from the broader status router allows the CPU-only FastAPI process to expose the endpoint without pulling in every status-related handler.

### File: docs/codex-fix-2025-11-09T11-41-15-653Z.md
**Changes**: Added this detailed fix report describing the issue, remediation, and validation guidance.

**Before**:
```text
(file did not exist)
```

**After**:
```markdown
# Bug Fix Report
...
```

**Reason**: Requirement to document the fix, affected files, and validation steps for traceability.

## Testing Recommendations
1. `uvicorn backend.cpu_tasks_app:app --port 8001` – start the CPU ingestion service locally and ensure it boots without errors.
2. `curl http://localhost:8001/api/index/status` – confirm the endpoint now returns the index status JSON payload (HTTP 200).
3. `uvicorn backend.main:app --port 8000` followed by `curl http://localhost:8000/api/index/status` – verify the primary API still exposes the same endpoint for completeness.

## Notes
- The shared `index_status_router` keeps the data-source logic in one place while allowing selective mounting across services.
- No database or schema changes were required; the endpoint continues to read the existing metadata file.

## Summary
Split the `/api/index/status` handler into a reusable router and mounted it on both FastAPI services so the frontend can always retrieve index metadata without hitting 404s.

Report generated: 2025-11-09T11:41:15.653Z
Fix tool: OpenAI Codex
